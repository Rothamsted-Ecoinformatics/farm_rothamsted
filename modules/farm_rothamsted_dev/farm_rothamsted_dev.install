<?php

/**
 * @file
 * Install, update and uninstall functions for the farm_rothamsted_dev module.
 */

use Drupal\asset\Entity\Asset;
use Drupal\log\Entity\Log;
use Drupal\user\Entity\User;

/**
 * Implements hook_install().
 */
function farm_rothamsted_dev_install() {

  // Setup users.
  // Manager.
  $manager = User::create([
    'name' => 'Manager',
    'status' => TRUE,
  ]);
  $manager->addRole('farm_manager');
  $manager->save();

  // Worker.
  $worker = User::create([
    'name' => 'Worker',
    'status' => TRUE,
  ]);
  $worker->addRole('farm_worker');
  $worker->save();

  // Operator.
  $operator = User::create([
    'name' => 'Operator',
    'status' => TRUE,
  ]);
  $operator->addRole('farm_operator');
  $operator->save();

  // @todo Setup taxonomies.
  // Units.
  // Log categories.
  // Materials.
  // Justifications.

  // EQUIPMENT ASSETS.
  // Define groups and equipment names.
  $equipment = [
    'Tractor Equipment' => ['Tractor 1', 'Tractor 2'],
    'Cultivation Equipment' => ['Cultivator', 'Roller'],
    'Drilling Equipment' => ['Drilling equip', 'Driller 2'],
    'Fertiliser Equipment' => ['Fertiliser equip', 'Manure spreader'],
    'Harvest Machinery Equipment' => ['Harvester 1', 'Harvester 2'],
    'Pesticide Equipment' => ['Sprayer 1', 'Spray mixer'],
  ];

  // Populate each group.
  foreach ($equipment as $group_name => $equipment_names) {

    // Create group asset.
    $group = Asset::create([
      'type' => 'group',
      'name' => $group_name,
      'status' => 'active',
    ]);
    $group->save();

    // Create equipment assets.
    $equipment_assets = array_map(function ($equipment_name) {
      $asset = Asset::create([
        'type' => 'equipment',
        'name' => $equipment_name,
        'status' => 'active',
      ]);
      $asset->save();
      return $asset;
    }, $equipment_names);

    // Assign equipment assets to the group.
    $group_assignment_log = Log::create([
      'type' => 'activity',
      'name' => "Create $group_name equipment assets",
      'group' => $group,
      'asset' => $equipment_assets,
      'is_group_assignment' => TRUE,
      'status' => 'done',
    ]);
    $group_assignment_log->save();
  }
}
